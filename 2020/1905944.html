<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>MySQL的SQL性能优化总结 | Nekilc</title>
  <meta name="author" content="Nekilc">
  
  <meta name="description" content="1. 对于select *要时刻保持谨慎的态度绝大多数情况，是不需要select *的。一旦使用了这种语句，便会让优化器无法完成索引覆盖扫描这类优化，而且还会增加额外的I/O、内存和CPU的消耗。当然，使用select *也并不是全是坏处，合理的使用select *可以简化开发，提高相同代码的复用性">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="MySQL的SQL性能优化总结"/>
  <meta property="og:site_name" content="Nekilc"/>

  
    <meta property="og:image" content="https://gitee.com/nieaowei/images/raw/master/blog/20200327190421.png" />
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Nekilc</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> MySQL的SQL性能优化总结</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="1-对于select-要时刻保持谨慎的态度"><a href="#1-对于select-要时刻保持谨慎的态度" class="headerlink" title="1. 对于select *要时刻保持谨慎的态度"></a>1. 对于select *要时刻保持谨慎的态度</h2><p>绝大多数情况，是不需要<code>select *</code>的。一旦使用了这种语句，便会让优化器无法完成索引覆盖扫描这类优化，而且还会增加额外的I/O、内存和CPU的消耗。<br>当然，使用<code>select *</code>也并不是全是坏处，合理的使用<code>select *</code>可以简化开发，提高相同代码的复用性。  </p>
<hr>
<h2 id="2-是否扫描的太多额外的记录"><a href="#2-是否扫描的太多额外的记录" class="headerlink" title="2. 是否扫描的太多额外的记录"></a>2. 是否扫描的太多额外的记录</h2><p>有时候会发现某些查询可能需要读取几千行数据，但是仅返回几条或者很少的结果，可以使用以下方式去优化：</p>
<ul>
<li>看看能否改表结构。例如使用汇总表</li>
<li>看看获取数据结果的方式是否最优，获取路劲是否已经是最短。<br>使用覆盖索引，把所有需要的列都放到索引中，以减少返回表中对应行中取数据的步骤。</li>
</ul>
<hr>
<h2 id="3-切分某些SQL语句"><a href="#3-切分某些SQL语句" class="headerlink" title="3. 切分某些SQL语句"></a>3. 切分某些SQL语句</h2><p>传统的互联网系统中，强调网络连接尽量少，数据层尽可能在一次连接中完成尽可能多的工作，防止建立多次链接，但是这种想法对于MySQL并不适用，MySQL从设计上让连接和断开都很轻量，在一般服务器上可以支持每秒超过10万的查询。<br>所以对于有些场景下，可以将一个大的查询“分而治之”，切分成小查询，然后再组合起来。例如以下情况：</p>
<ul>
<li>对于全量数据查询变成分页。假如一张表中有数千万条数据，一次<code>select all</code>，肯定是不行的。可以换成一次取一部分，把一次的压力分摊。</li>
<li>删除大量旧数据的时候，不要一个大的语句一次性清完，推荐一次删一万条。如果用一个大的语句一次性完成的话，可能需要一次锁住大量数据，占满大量日志事务，让Mysql停在那儿了，为避免这种情况发生，最好一次性删除一万条左右的数据，然后每次删完暂停一会儿再操作，将服务器上的一次性压力分散。</li>
</ul>
<p>注意：虽然Mysql建立连接十分轻量，但是这不意味着可以逐条循环中查询然后再拼接，这样效率依然是非常慢，而且通常是工作中sql优化的点。  </p>
<hr>
<h2 id="4-慎用join操作"><a href="#4-慎用join操作" class="headerlink" title="4. 慎用join操作"></a>4. 慎用<code>join</code>操作</h2><p>这算是一条禁忌吧，很多公司的互联网产品都杜绝join操作，换成先从一张表中先取出数据id，再从另外一张表中使用<code>where in</code>查询的两次单表查询操作。主要是以下几点原因：</p>
<ul>
<li>让应用的缓存(redis、memcache等)更高效。例如在第一张表中查询出部分id了，如果命中了缓存，就可以省去一条<code>where in</code>语句了。</li>
<li>更容易应对业务的发展，方便对数据库进行拆分，更容易做到高性能和高扩展。</li>
<li>对where in中的id进行升序排序后，查询效率比join的随机关联更高效</li>
<li>减少多余的查询。在应用层中两次查询，意味着对某条记录应用只需要查询一次，而使用<code>join</code>可能需要重复的扫描访问一部分数据。</li>
<li>单张表查询可以减少锁的竞争。<br>假如非用不可，可以采用以下方式来优化：</li>
<li>确保<code>ON</code>或者<code>using</code>子句中的列上有索引</li>
<li>确保任何的<code>group by</code>和<code>order by</code>中的表达式只涉及到一个表中的列。</li>
</ul>
<hr>
<h2 id="5-在性能要求比较高的场景中，杜绝查询中使用临时表"><a href="#5-在性能要求比较高的场景中，杜绝查询中使用临时表" class="headerlink" title="5. 在性能要求比较高的场景中，杜绝查询中使用临时表"></a>5. 在性能要求比较高的场景中，杜绝查询中使用临时表</h2><p>MySQL的临时表示没有任何索引的，使用临时表一般都意味着性能比较低,因此在对性能要求比较高的场景中，最好不要使用带有临时表的操作：</p>
<ul>
<li>未带索引的字段上的<code>group by</code>操作。</li>
<li>UNION查询。</li>
<li>查询语句中的子查询。</li>
<li>部分<code>order by</code>操作，例如<code>distinct</code>函数和<code>order by</code>一起使用且<code>distinct</code>和<code>order by</code>同一个字段。再例如某些情况下<code>group by</code>和<code>order by</code>字段不同。<br>具体是否用到临时表，可以通过explain来查看，查看Extra列的结果，如果出现<code>Using temporary</code>则需要注意。</li>
</ul>
<hr>
<h2 id="6-count-函数优化"><a href="#6-count-函数优化" class="headerlink" title="6. count()函数优化"></a>6. <code>count()</code>函数优化</h2><p><code>count()</code>函数有一点需要特别注意：它是不统计值为NULL的字段的！所以:</p>
<ul>
<li>不能指定查询结果的某一列，来统计结果行数。即<code>count(xx column)</code> 不太好。</li>
<li>如果想要统计结果集，就使用<code>count(\*)</code>，性能也会很好。</li>
<li>尽量不使用子查询</li>
<li>尽量别使用子查询，尽可能的使用关联来代替</li>
</ul>
<hr>
<h2 id="7-优化分页limit"><a href="#7-优化分页limit" class="headerlink" title="7. 优化分页limit"></a>7. 优化分页<code>limit</code></h2><p>通常我们在分页的时候，通常使用的是limit 50, 10这种语句。数据少还不错，但是当数据偏移量非常大的时候，性能就会出现问题，例如select xx,xxx from test_table limit 100000020, 20。扫描了100000020条数据，才返回20条数据。这个时候我们可以用一下两种方式来优化：</p>
<ul>
<li>利用between and和主键索引</li>
<li>利用主键自增id，我们如果知道了分页的上边界，以上查询可以改写为：<br><code>select xxx, xxx from test_table where id between xxxxx and xxxx</code>。<br>利用自增主键索引、<code>order by</code>加<code>limit</code>，不使用<code>offset</code></li>
</ul>
<p>limit和offset的问题，其实就是offset的问题，它会导致MySQL扫描大量不需要的行然后再抛弃掉。如果使用某个标签记录上一次所取数据的位置，那么下次就可以直接从书签位置开始扫描，这样就可以避免使用offset。<br>例如以上查询可以改为:<br>第一组数据：<code>select xxx, xxxx from test_table order by id desc limit 20;</code><br>这样就拿到了本次数据和下次数据的分解id值，则下一页查询就知道可以：<br><code>select xxx, xxx from test_table where id &lt; &#39;上页id分界值&#39; order by id desc limit 20</code></p>
<hr>
<h2 id="8-熟悉并灵活使用explain"><a href="#8-熟悉并灵活使用explain" class="headerlink" title="8. 熟悉并灵活使用explain"></a>8. 熟悉并灵活使用<code>explain</code></h2><p>以下是mysql执行查询的整个过程，explain可以查看图中标红部分，</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2020/YE6KFM.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2020/FC7S68.html" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2020-02-06 01:14:40 
	</br>
	<i class="fa fa-pencil"></i>
	2020-03-27 19:04:50 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/数据库/">数据库<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/数据库/">数据库<span>3</span></a></li> <li><a href="/tags/Mysql/">Mysql<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#1-对于select-要时刻保持谨慎的态度"><span class="toc-article-text">1. 对于select *要时刻保持谨慎的态度</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#2-是否扫描的太多额外的记录"><span class="toc-article-text">2. 是否扫描的太多额外的记录</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#3-切分某些SQL语句"><span class="toc-article-text">3. 切分某些SQL语句</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#4-慎用join操作"><span class="toc-article-text">4. 慎用join操作</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#5-在性能要求比较高的场景中，杜绝查询中使用临时表"><span class="toc-article-text">5. 在性能要求比较高的场景中，杜绝查询中使用临时表</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#6-count-函数优化"><span class="toc-article-text">6. count()函数优化</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#7-优化分页limit"><span class="toc-article-text">7. 优化分页limit</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#8-熟悉并灵活使用explain"><span class="toc-article-text">8. 熟悉并灵活使用explain</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 <a href="https://www.nekilc.com" target="_blank">Nekilc</a> 
  
      <!-- with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind.386</a>.     -->
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
